(function(p,l){function q(a,e,b,t,x,f){var c=e/u,m=c*f.aperture,h=Math.PI/180*f.starDir,r=Math.sin(h),h=Math.cos(h),g=[],n=Math.asin(f.aperture/u),v=new GeomContainer;if(f.parabolic){for(var d=2*c*f.aperture/f.numMirror,k=-d*(f.numMirror-1)/2,c=0;c<f.numMirror;c++)g.push(k+c*d-d/2*f.mirrorDensity),g.push(k+c*d+d/2*f.mirrorDensity);v.addChild(new Parabola([0,e],e/2,Math.PI,g))}else{d=2*n/f.numMirror;k=Math.PI/2-n+d/2;for(c=0;c<f.numMirror;c++)g.push(k+c*d-d/2*f.mirrorDensity),g.push(k+c*d+d/2*f.mirrorDensity);
v.addChild(new Arc([0,0],e,g))}g=[];for(c=-f.nbRays;c<=f.nbRays;c++){for(var d=m*c*f.raySpan/f.nbRays,k=-2*e,k=[d*h-k*r,e+d*r+k*h],s=[-r,h],d=[k],q=0;10>q;q++){var w=v.intersect(k,s);if(0===w.length)break;k=w[0];d.push(k);s=p.refl(s,w[1])}1===d.length?d.push(p.add2(k,p.mul2(3*e,s))):d.push(p.add2(k,p.mul2(0.75*e,s)));g.push(d)}a.lineWidth=t;if(1===b){a.strokeStyle="#202020";a.beginPath();for(c=0;c<g.length;c++)d=g[c],2===d.length&&l.segment(a,d[0],d[1]);a.stroke();a.strokeStyle="grey";a.beginPath();
for(c=0;c<g.length;c++)d=g[c],2<d.length&&l.segment(a,d[0],d[1]);a.stroke()}a.strokeStyle="white";a.beginPath();for(c=0;c<g.length;c++)d=g[c],2<d.length&&(l.polyline(a,d,1),l.arrowHead(a,d[d.length-2],d[d.length-1],10));a.stroke();a.fillStyle="#FFFF20";for(c=0;c<g.length;c++)d=g[c],t=p.march(e*f.length,d),l.circle(a,t[0],t[1],3);a.fillStyle="#FFFF20";a.strokeStyle="black";a.lineWidth=1;l.star(a,(e-x)*r/h,x,15);a.strokeStyle="#0080FF";a.fillStyle="#0080FF";l.circle(a,0,0,10);1===b&&l.arc(a,0,0,e/2,
Math.PI/2-3*n);a.strokeStyle="#40C0FF";a.fillStyle="#40C0FF";a.lineWidth=5;a.fillStyle="#FFFF20";v.draw(a);a.strokeStyle="#40FFC0";a.fillStyle="#40FFC0";f.drawFocal&&l.circle(a,-r*e/2,h*e/2,5);return 0/e}function n(){var a=$("#schema")[0],e=$("div.slider,input[type=checkbox],input[type=radio]").getUIData();e.raySpan=0.99;var b=a.getContext("2d");b.save();var l=$("body").css("background-color");b.fillStyle=l;b.fillRect(0,0,a.width,a.height);var n=Math.PI/180*e.starDir,f=0.9*Math.min(0.95*a.height,
0.95*a.width/2);b.save();var c=0.975*a.height-f;b.translate(a.width/2,c);q(b,f,1,2,25-c,e);b.restore();var c=0,m,h;1<e.zoom&&(b.save(),b.translate(-5,5),m=a.width/3,h=a.height/3,b.fillStyle=l,b.fillRect(2*m,0,m,h),b.strokeStyle="#506070",b.fillStyle="#C0D0E0",b.beginPath(),b.rect(2*m,0,m,h),b.stroke(),b.clip(),b.font="18px Arial",b.fillText("Zoom: "+Math.round(10*e.zoom)/10+"x",2*m+5,20),f*=e.zoom,b.translate(2*m+a.width/6+f/2*Math.sin(n),a.height/6-f/2*Math.cos(n)),c=q(b,f,e.zoom,0.5,-999,e),b.restore());
e.legend&&(m=250,h=85,b.save(),b.translate(5,5),b.fillStyle=l,b.fillRect(0,0,m,h),b.fillStyle="#C0D0E0",b.strokeStyle="#506070",b.beginPath(),b.rect(0,0,m,h),b.stroke(),b.clip(),b.font="24px Arial",b.fillText("C1 Radius: "+u+"m",5,25),a=Math.round(e.aperture),b.fillText("Ground radius: "+a+"m",5,50),0<c&&(a=u*c,0.2<a?(a=5<a?Math.round(a):Math.round(100*a)/100,b.fillText("Image size: "+a+"m",5,75)):(a*=1E3,a=5<a?Math.round(a):0.02<a?Math.round(100*a)/100:Math.round(1E4*a)/1E4,b.fillText("Image size: "+
a+"mm",5,75))),b.restore());window.recordingFrameNumber&&$("#schema").icanvas("saveFrame","sphMirror",window.recordingFrameNumber)}function y(){var a={HD:[1280,720],FullHD:[1920,1080],"*":[768,576]},e=a[$("#res").val()];void 0===e&&(e=a["*"]);$("#schema").attr({width:e[0],height:e[1]});n()}var u=202;$("document").ready(function(){$("#schema").icanvas();$.finalizeUI();$("input").on("change",n);$("div.slider").on("slidechange",n);$("div.slider").on("change",n);$("#res").change(y);$("#zoom").val(20);
$("#dispFocal").attr("checked",!0);$("#res").val("PAL");y()})})(G,D);
